export LANG=en_US.UTF-8
export EDITOR='nvim'
export DOTFILES=$HOME/.dotfiles
export WORKSPACE=$HOME/workspace

source $DOTFILES/wtg/env
PERSONAL=$DOTFILES/personal/env
for i in `find -L $PERSONAL`; do
  source $i
done

source $DOTFILES/zsh/fzf.zsh

# Case insensitive.
zstyle ':completion:*' matcher-list 'm:{[:lower:][:upper:]}={[:upper:][:lower:]}' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*'

switch() {
  if [[ -z "$1" ]]; then
    selected=`echo "personal wtg" | tr ' ' '\n' | fzf`
  else
    selected="$1"
  fi

  [[ -f ~/.npmrc ]] && rm ~/.npmrc
  [[ -f ~/.ssh/config ]] && rm ~/.ssh/config
  if [[ "$selected" == "personal" ]]; then
    if [[ -f $DOTFILES/personal/.npmrc ]]; then
      ln -s $DOTFILES/personal/.npmrc ~/.npmrc
    fi
    if [[ -f $DOTFILES/personal/ssh/config ]]; then
      ln -s $DOTFILES/personal/ssh/config ~/.ssh/config
    fi
  elif [[ "$selected" == "wtg" ]]; then
    if [[ -f $DOTFILES/wtg/.npmrc ]]; then
      ln -s $DOTFILES/wtg/.npmrc ~/.npmrc
    fi
    if [[ -f $DOTFILES/wtg/ssh/config ]]; then
      ln -s $DOTFILES/wtg/ssh/config ~/.ssh/config
    fi
  fi
}

vmrss() {
  p=$1
  if [[ -z $p ]]; then
    p=$(ps -eo pid,user,comm | tail -n +2 | fzf | awk '{print $1}')
  fi

  while true; do
    if [[ -d "/proc" ]]; then
      cat /proc/$p/status | grep VmRSS | awk '{print $1/1024 " MB"}'
    else
      vmmap --summary -resident $p | grep "Physical footprint:" | awk '{print $3}'
    fi
    sleep 1
  done
}

git-contrib() {
  git shortlog -sne --all
}

switch "personal"

source $HOME/.nix-profile/share/nix-direnv/direnvrc
eval "$(direnv hook zsh)"
